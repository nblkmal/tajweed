---
import '../styles/global.css';

const { frontmatter } = Astro.props;
const title = frontmatter?.title ?? '';
const lang = frontmatter?.lang ?? 'en';
const path = Astro.url.pathname;

const navLinks = lang === 'bm'
  ? [
      { href: '/bm',       label: 'Tajweed' },
      { href: '/bm/waqaf', label: 'Waqaf' },
    ]
  : [
      { href: '/en',       label: 'Tajweed' },
      { href: '/en/waqaf', label: 'Waqaf' },
    ];
---

<!doctype html>
<html lang={lang === 'bm' ? 'ms' : 'en'}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="A guide to Tajweed — the rules of Quran recitation." />
    <title>{title}</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet" />
  </head>

  <body class="min-h-screen" style="font-family: 'Inter', sans-serif; background: #09090b;">

    <!-- Background blobs -->
    <div class="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
      <div style="position:absolute;top:-80px;left:-80px;width:440px;height:440px;background:radial-gradient(circle,rgba(124,58,237,0.18) 0%,transparent 70%);border-radius:50%;"></div>
      <div style="position:absolute;top:40%;right:-100px;width:380px;height:380px;background:radial-gradient(circle,rgba(217,119,6,0.12) 0%,transparent 70%);border-radius:50%;"></div>
      <div style="position:absolute;bottom:0;left:35%;width:320px;height:320px;background:radial-gradient(circle,rgba(139,92,246,0.08) 0%,transparent 70%);border-radius:50%;"></div>
    </div>

    <!-- Navbar -->
    <nav class="sticky top-0 z-30 border-b" style="background:rgba(9,9,11,0.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-color:rgba(39,39,42,0.8);">
      <div class="max-w-6xl mx-auto px-4 h-14 flex items-center justify-between">
        <div class="flex items-center gap-6">
          <nav class="flex items-center gap-1">
            {navLinks.map(({ href, label }) => (
              <a
                href={href}
                class={`px-3 py-1 rounded-lg text-sm font-medium transition-all ${path === href || path === href + '/' ? 'text-white bg-violet-950/60' : 'text-white hover:text-white hover:bg-zinc-800'}`}
              >
                {label}
              </a>
            ))}
          </nav>
        </div>
        <div class="flex gap-1 p-1 rounded-full border" style="background:rgba(255,255,255,0.05);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border-color:rgba(63,63,70,0.6);">
          <a href="/en" class={`px-4 py-1 rounded-full text-sm font-medium transition-all ${lang === 'en' ? 'bg-zinc-800 text-white shadow-sm' : 'text-white hover:text-white'}`}>English</a>
          <a href="/bm" class={`px-4 py-1 rounded-full text-sm font-medium transition-all ${lang === 'bm' ? 'bg-zinc-800 text-white shadow-sm' : 'text-white hover:text-white'}`}>Melayu</a>
        </div>
      </div>
    </nav>

    <!-- Mobile jump bar -->
    <div id="mobile-jump-bar" class="sticky top-14 z-20 border-b py-2 overflow-x-auto flex gap-2 scrollbar-hide px-4 lg:pl-[calc(260px+2.5rem+1rem)] lg:pr-4" style="display:none!important;background:rgba(9,9,11,0.85);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-color:rgba(39,39,42,0.8);"></div>

    <!-- Page layout -->
    <div class="max-w-6xl mx-auto px-4 lg:grid lg:grid-cols-[260px_1fr] lg:gap-10">

      <!-- Sidebar: sticky + full viewport height below navbar = never moves -->
      <aside class="hidden lg:block">
        <div class="sticky top-14 h-[calc(100vh-3.5rem)] overflow-y-auto py-8 pr-4 scrollbar-hide border-r border-zinc-800">
          <p class="text-[11px] font-bold text-white uppercase tracking-widest mb-4">
            {lang === 'bm' ? 'Kandungan' : 'On this page'}
          </p>
          <nav id="toc" class="flex flex-col gap-0.5 text-sm"></nav>
        </div>
      </aside>

      <!-- Article -->
      <main class="py-10 min-w-0">
        <article id="article" class="prose prose-invert max-w-none
          prose-headings:font-semibold
          prose-h1:text-3xl prose-h1:font-bold prose-h1:mb-1
          prose-h2:text-lg prose-h2:mt-12 prose-h2:mb-4 prose-h2:text-white
          prose-h3:text-[15px] prose-h3:mb-3 prose-h3:text-white
          prose-p:text-white prose-p:leading-relaxed prose-p:text-[15px]
          prose-li:text-white prose-li:text-[15px]
          prose-strong:text-white
          prose-table:text-sm prose-table:border-collapse
          prose-th:text-left prose-th:font-semibold prose-th:text-white prose-th:bg-violet-950 prose-th:px-4 prose-th:py-2
          prose-td:px-4 prose-td:py-2 prose-td:text-white prose-td:border-b prose-td:border-zinc-800
          prose-blockquote:not-italic prose-blockquote:border-l-4 prose-blockquote:border-violet-500 prose-blockquote:bg-violet-950/30 prose-blockquote:text-white prose-blockquote:rounded-r-xl prose-blockquote:py-3 prose-blockquote:px-4
          prose-code:text-white prose-code:bg-violet-950 prose-code:px-1 prose-code:rounded
          prose-hr:border-zinc-800">
          <slot />
        </article>
      </main>
    </div>

    <!-- Footer -->
    <footer class="border-t border-zinc-800 py-8 text-center text-xs text-white">
      Built with Astro &amp; Tailwind CSS
    </footer>

    <style>
      .scrollbar-hide::-webkit-scrollbar { display: none; }
      .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

      /* Rule cards injected by JS */
      .rule-card {
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-radius: 16px;
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 12px rgba(0,0,0,0.4);
        border-left-width: 4px;
        position: relative;
        overflow: hidden;
        transition: all 0.2s ease;
      }
      .rule-card::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, transparent, rgba(124,58,237,0.07));
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }
      .rule-card:hover {
        background: rgba(255, 255, 255, 0.06);
        box-shadow: 0 8px 28px rgba(0,0,0,0.5);
        transform: translateY(-2px);
      }
      .rule-card:hover::before {
        opacity: 1;
      }
      .rule-card h3 {
        margin-top: 0 !important;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #ffffff !important;
      }
      .rule-card table {
        margin-top: 0.75rem;
      }
      .rule-badge {
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        width: 26px !important;
        height: 26px !important;
        min-width: 26px !important;
        border-radius: 50% !important;
        font-size: 11px !important;
        line-height: 1 !important;
        font-weight: 700 !important;
        flex-shrink: 0 !important;
        color: white !important;
        vertical-align: middle !important;
      }

      /* Arabic text */
      .arabic-text {
        font-family: 'Amiri', serif;
        font-size: 1.4em;
        direction: rtl;
        letter-spacing: 0.05em;
        color: #ffffff;
      }

      /* TOC active state */
      .toc-link.active {
        color: #ffffff;
        background: rgba(124, 58, 237, 0.15);
        font-weight: 600;
      }

      /* Mobile chip active state */
      .mobile-chip.chip-active {
        font-weight: 700;
        box-shadow: 0 0 0 2px currentColor;
      }

      /* Offset anchor targets below fixed navbar */
      #article h1, #article h2, #article h3 {
        scroll-margin-top: 72px;
      }
      @media (max-width: 1024px) {
        #article h1, #article h2, #article h3 {
          scroll-margin-top: 116px;
        }
      }
    </style>

    <script>
      const RULE_COLORS = [
        { border: '#10b981', badge: '#6ee7b7' },
        { border: '#3b82f6', badge: '#93c5fd' },
        { border: '#8b5cf6', badge: '#c4b5fd' },
        { border: '#f59e0b', badge: '#fcd34d' },
        { border: '#ef4444', badge: '#fca5a5' },
        { border: '#06b6d4', badge: '#67e8f9' },
        { border: '#ec4899', badge: '#f9a8d4' },
        { border: '#84cc16', badge: '#bef264' },
        { border: '#f97316', badge: '#fdba74' },
      ];

      function wrapRuleCards() {
        const article = document.getElementById('article');
        if (!article) return;

        const h3s = Array.from(article.querySelectorAll('h3'));
        h3s.forEach((h3, index) => {
          const color = RULE_COLORS[index % RULE_COLORS.length];

          const siblings = [];
          let next = h3.nextElementSibling;
          while (next && next.tagName !== 'H3' && next.tagName !== 'H2') {
            const after = next.nextElementSibling;
            if (next.tagName === 'HR') { next.remove(); break; }
            siblings.push(next);
            next = after;
          }

          const card = document.createElement('section');
          card.className = 'rule-card';
          card.style.borderLeftColor = color.border;
          card.dataset.rule = String(index + 1);

          h3.parentNode.insertBefore(card, h3);
          card.appendChild(h3);
          siblings.forEach(el => card.appendChild(el));

          const num = h3.textContent.match(/^(\d+)\./)?.[1];
          if (num) {
            h3.innerHTML = h3.innerHTML.replace(/^\d+\.\s*/, '');
            const badge = document.createElement('span');
            badge.textContent = num;
            badge.style.cssText = `
              display: inline-flex;
              align-items: center;
              justify-content: center;
              width: 26px;
              height: 26px;
              min-width: 26px;
              border-radius: 50%;
              font-size: 11px;
              line-height: 1;
              font-weight: 700;
              flex-shrink: 0;
              color: ${color.badge};
              background-color: ${color.badge}22;
              border: 1px solid ${color.badge}55;
            `;
            h3.prepend(badge);
          }

          card.querySelectorAll('blockquote p').forEach(p => {
            if (/[\u0600-\u06FF]/.test(p.textContent)) p.classList.add('arabic-text');
          });
        });

        article.querySelectorAll('blockquote p').forEach(p => {
          if (/[\u0600-\u06FF]/.test(p.textContent)) p.classList.add('arabic-text');
        });
      }

      function buildTOC() {
        const article = document.getElementById('article');
        const toc = document.getElementById('toc');
        const mobileBar = document.getElementById('mobile-jump-bar');
        if (!article || !toc) return;

        const headings = Array.from(article.querySelectorAll('h2, h3'));
        const ruleHeadings = [];

        headings.forEach((h, i) => {
          const rawText = h.textContent
            .replace(/^\d+\.\s*/, '')
            .split('(')[0]
            .split('—')[0]
            .split('–')[0]
            .trim();
          const slug = rawText
            .toLowerCase()
            .replace(/[^a-z0-9\s]/g, '')
            .trim()
            .replace(/\s+/g, '-')
            .replace(/^-+|-+$/g, '')
            .substring(0, 50);
          h.id = slug || `heading-${i}`;

          const isH3 = h.tagName === 'H3';
          const link = document.createElement('a');
          link.href = `#${h.id}`;
          link.dataset.headingId = h.id;

          const cleanLabel = h.textContent
            .replace(/^\d+\.\s*/, '')
            .split('(')[0]
            .split('—')[0]
            .split('–')[0]
            .trim();

          if (isH3) {
            const num = h.textContent.match(/\d+/)?.[0];
            const color = num ? RULE_COLORS[(parseInt(num) - 1) % RULE_COLORS.length] : RULE_COLORS[0];
            link.className = 'toc-link flex items-center gap-2 px-2 py-1.5 rounded-lg text-white hover:text-white hover:bg-zinc-800 transition-colors';
            link.innerHTML = `
              <span class="toc-badge flex-shrink-0 w-5 h-5 rounded-full text-[10px] font-bold flex items-center justify-center" style="color:${color.badge};background-color:${color.badge}22;border:1px solid ${color.badge}55;">${num || '·'}</span>
              <span class="truncate text-[13px]">${cleanLabel}</span>
            `;
            ruleHeadings.push({ id: h.id, label: cleanLabel, num, color });
          } else {
            link.className = 'toc-link flex items-center px-2 py-1.5 rounded-lg text-[11px] font-semibold uppercase tracking-wider text-white hover:text-white transition-colors mt-3 first:mt-0';
            link.textContent = cleanLabel;
          }

          toc.appendChild(link);
        });

        if (mobileBar && ruleHeadings.length > 0) {
          mobileBar.style.removeProperty('display');
          mobileBar.style.display = 'flex';

          ruleHeadings.forEach(({ id, label, num, color }) => {
            const chip = document.createElement('a');
            chip.href = `#${id}`;
            chip.className = 'mobile-chip flex-shrink-0 flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium border transition-colors whitespace-nowrap';
            chip.style.borderColor = color.badge + '40';
            chip.style.color = '#ffffff';
            chip.style.backgroundColor = color.badge + '10';
            chip.innerHTML = label;
            mobileBar.appendChild(chip);
          });
        }
      }

      function getStickyOffset() {
        const navbar = document.querySelector('nav');
        const mobileBar = document.getElementById('mobile-jump-bar');
        let offset = navbar ? navbar.offsetHeight : 56;
        if (mobileBar && mobileBar.offsetHeight > 0) offset += mobileBar.offsetHeight;
        return offset + 16;
      }

      function setupScrollspy() {
        const headings = Array.from(document.querySelectorAll('#article h2, #article h3'));

        function getActiveId() {
          const threshold = window.scrollY + getStickyOffset() + 10;
          let activeId = null;
          for (const h of headings) {
            if (h.getBoundingClientRect().top + window.scrollY <= threshold) {
              activeId = h.id;
            } else {
              break;
            }
          }
          return activeId;
        }

        function updateActive() {
          const activeId = getActiveId();
          document.querySelectorAll('.toc-link').forEach(link => {
            link.classList.toggle('active', link.dataset.headingId === activeId);
          });
          document.querySelectorAll('.mobile-chip').forEach(chip => {
            const chipId = chip.getAttribute('href')?.replace('#', '');
            chip.classList.toggle('chip-active', chipId === activeId);
          });
        }

        window.addEventListener('scroll', updateActive, { passive: true });
        updateActive();
      }

      function setupSmoothScroll() {
        document.addEventListener('click', e => {
          const link = e.target.closest('a[href^="#"]');
          if (!link) return;
          e.preventDefault();
          const id = link.getAttribute('href').replace(/^#/, '');
          const target = document.getElementById(id);
          if (target) {
            window.scrollTo({ top: target.getBoundingClientRect().top + window.scrollY - getStickyOffset(), behavior: 'smooth' });
          }
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        buildTOC();
        wrapRuleCards();
        setupScrollspy();
        setupSmoothScroll();
      });
    </script>

  </body>
</html>
